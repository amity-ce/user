<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Tracker - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        .modal-active { display: flex !important; }
        .btn-loading { pointer-events: none; position: relative; color: transparent !important; }
        .btn-loading::after {
            content: ""; position: absolute; left: 50%; top: 50%; width: 16px; height: 16px;
            margin-left: -8px; margin-top: -8px; border: 2px solid #ffffff; border-top-color: transparent;
            border-radius: 50%; animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .history-scroll::-webkit-scrollbar { width: 4px; }
        .history-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-28">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-6 shadow-xl sticky top-0 z-30">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="flame" class="w-6 h-6 text-orange-500"></i>
                        Guild Tracker
                    </h1>
                    <div class="flex items-center gap-1.5 text-slate-400 text-[10px] mt-1 bg-slate-800 w-fit px-2 py-1 rounded-md uppercase tracking-tight font-semibold">
                        <span id="connectionStatus" class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span> Connecting...
                        </span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] uppercase tracking-wider text-slate-400">ทองรวมสัปดาห์นี้</div>
                    <div id="totalWeeklyGold" class="text-2xl font-mono font-bold text-yellow-400">0 <span class="text-sm font-sans">g</span></div>
                </div>
            </div>
            
            <div class="flex bg-slate-800 p-1 rounded-xl">
                <button onclick="switchView('members')" id="tab-members" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-indigo-600 text-white shadow-lg">สถิติสมาชิก</button>
                <button onclick="switchView('history')" id="tab-history" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all text-slate-400">ประวัติทั้งหมด</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-4">
        <!-- Week Info -->
        <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-xl flex items-start gap-3 text-indigo-800 text-[10px] md:text-xs">
            <i data-lucide="calendar-days" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
            <p id="weekRangeLabel">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Search -->
        <div class="relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
            <input type="text" id="searchInput" oninput="renderApp()" placeholder="ค้นหาชื่อสมาชิก..." class="w-full pl-10 pr-4 py-3 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-indigo-500 bg-white outline-none">
        </div>

        <!-- View: Members -->
        <div id="view-members" class="space-y-3">
            <div class="py-20 text-center text-slate-400 flex flex-col items-center gap-2">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-400"></i>
                <p>กำลังโหลดฐานข้อมูล Firebase...</p>
            </div>
        </div>

        <!-- View: History -->
        <div id="view-history" class="hidden animate-in fade-in duration-300">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-50 font-bold text-xs text-slate-400 uppercase bg-slate-50/50 flex justify-between items-center">
                    <span>รายการล่าสุด</span>
                    <span id="historyCount" class="text-indigo-600 bg-indigo-50 px-2 py-1 rounded">0 รายการ</span>
                </div>
                <div id="historyList" class="divide-y divide-slate-50 max-h-[60vh] overflow-y-auto history-scroll"></div>
            </div>
        </div>
    </main>

    <!-- Floating Add Button -->
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-full max-w-sm px-6 z-20">
        <button id="mainAddBtn" onclick="toggleModal('modal-add', true)" disabled class="w-full bg-slate-800 text-white py-4 rounded-2xl shadow-2xl flex items-center justify-center gap-2 font-bold hover:bg-slate-700 active:scale-95 transition-all opacity-50 cursor-not-allowed">
            <i data-lucide="loader-2" class="w-5 h-5 animate-spin" id="addBtnIcon"></i>
            <span id="addBtnText">กำลังเชื่อมต่อ...</span>
        </button>
    </div>

    <!-- Modals -->
    <div id="modal-add" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2.5rem] sm:rounded-[2rem] w-full max-w-md p-8 shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">เพิ่มสมาชิกใหม่</h2>
                <button onclick="toggleModal('modal-add', false)" class="p-2 bg-slate-100 rounded-full text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="newMemberName" oninput="validateName()" placeholder="พิมพ์ชื่อ..." class="w-full px-5 py-4 rounded-2xl border bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500">
                <p id="dupError" class="hidden text-red-500 text-xs ml-1">ชื่อนี้มีอยู่ในระบบแล้ว</p>
                <button id="btnConfirmAdd" onclick="handleAddMember()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold disabled:opacity-50">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="modal-delete" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-full max-w-xs p-6 shadow-2xl">
            <div class="text-center space-y-4">
                <div class="w-14 h-14 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto"><i data-lucide="alert-triangle" class="w-7 h-7"></i></div>
                <h2 class="text-xl font-bold">ยืนยันการลบ?</h2>
                <p id="deleteDesc" class="text-sm text-slate-500"></p>
                <div class="w-full flex flex-col gap-2 pt-2">
                    <button id="btnConfirmDelete" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold">ลบเลย</button>
                    <button onclick="toggleModal('modal-delete', false)" class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // ใช้ App ID ที่คุณให้มาเป็น Fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : '1:254277296307:web:fdf52604085008b5b610c6';

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let members = [];
        let donations = [];
        let userId = null;

        // --- Auth Sequence ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed:", error);
                alert("เกิดข้อผิดพลาดในการยืนยันตัวตนกับ Firebase");
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                updateStatus(true);
                enableButtons();
                setupListeners();
            }
        });

        function updateStatus(online) {
            const el = document.getElementById('connectionStatus');
            el.innerHTML = online 
                ? `<span class="w-2 h-2 rounded-full bg-green-400"></span> Online (AppID: ...${appId.slice(-4)})`
                : `<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Connecting...`;
        }

        function enableButtons() {
            const btn = document.getElementById('mainAddBtn');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('addBtnText').innerText = "เพิ่มสมาชิกใหม่";
            document.getElementById('addBtnIcon').outerHTML = `<i data-lucide="user-plus" class="w-5 h-5"></i>`;
            lucide.createIcons();
        }

        function setupListeners() {
            // Listen Members
            const memRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            onSnapshot(memRef, (snapshot) => {
                members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            });

            // Listen Donations
            const donRef = collection(db, 'artifacts', appId, 'public', 'data', 'donations');
            onSnapshot(donRef, (snapshot) => {
                donations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            });
        }

        // --- Core Functions ---
        
        window.handleAddMember = async () => {
            if (!auth.currentUser) return;

            const nameInput = document.getElementById('newMemberName');
            const name = nameInput.value.trim();
            if (!name) return;
            
            const btn = document.getElementById('btnConfirmAdd');
            btn.innerText = ""; // Clear text for spinner
            btn.classList.add('btn-loading');

            try {
                const memRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
                await addDoc(memRef, {
                    name: name,
                    createdAt: new Date().toISOString()
                });
                toggleModal('modal-add', false);
                nameInput.value = '';
            } catch (err) {
                console.error(err);
                alert("บันทึกไม่สำเร็จ: " + err.message);
            } finally {
                btn.innerText = "ยืนยัน";
                btn.classList.remove('btn-loading');
            }
        };

        window.handleDonate = async (mId) => {
             if (!auth.currentUser) return;

            const btn = document.querySelector(`[data-id="${mId}"]`);
            if (btn) btn.classList.add('btn-loading');

            try {
                const donRef = collection(db, 'artifacts', appId, 'public', 'data', 'donations');
                await addDoc(donRef, {
                    memberId: mId,
                    amount: 150,
                    timestamp: new Date().toISOString()
                });
            } catch (err) {
                alert("บริจาคไม่สำเร็จ: " + err.message);
                if (btn) btn.classList.remove('btn-loading');
            }
        };

        window.handleDeleteMember = async (id) => {
            if (!auth.currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id));
                // Cleanup donations (Client-side loop for simple app)
                const toDelete = donations.filter(d => d.memberId === id);
                toDelete.forEach(async (d) => {
                   await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'donations', d.id));
                });
                toggleModal('modal-delete', false);
            } catch (err) {
                alert("ลบไม่สำเร็จ: " + err.message);
            }
        };

        // --- Render UI ---
        
        function getMondayStart() {
            const d = new Date();
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1) - day;
            const monday = new Date(d);
            monday.setDate(d.getDate() + diff);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        window.renderApp = () => {
            const monday = getMondayStart();
            document.getElementById('weekRangeLabel').innerText = `รอบสัปดาห์: ${monday.toLocaleDateString('th-TH')} - ปัจจุบัน`;
            
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = members.filter(m => m.name.toLowerCase().includes(search));
            const weeklyLogs = donations.filter(d => new Date(d.timestamp) >= monday);

            const weeklyTotal = weeklyLogs.reduce((acc, curr) => acc + Number(curr.amount || 0), 0);
            document.getElementById('totalWeeklyGold').innerText = `${weeklyTotal.toLocaleString()} g`;

            const listEl = document.getElementById('view-members');
            listEl.innerHTML = '';

            filtered.sort((a,b) => {
                const aVal = weeklyLogs.filter(d => d.memberId === a.id).reduce((s, x) => s + Number(x.amount), 0);
                const bVal = weeklyLogs.filter(d => d.memberId === b.id).reduce((s, x) => s + Number(x.amount), 0);
                return bVal - aVal;
            });

            filtered.forEach((m, idx) => {
                const mWeekly = weeklyLogs.filter(d => d.memberId === m.id);
                const weekGold = mWeekly.reduce((s, x) => s + Number(x.amount || 0), 0);
                const totalGold = donations.filter(d => d.memberId === m.id).reduce((s, x) => s + Number(x.amount || 0), 0);
                const hasDonated = mWeekly.some(d => Number(d.amount) === 150);

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4 animate-in fade-in";
                card.innerHTML = `
                    <div class="flex items-center justify-between flex-1">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs ${idx < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-100 text-slate-500'}">${idx + 1}</div>
                            <div>
                                <h3 class="font-bold text-slate-700 leading-none mb-1">${m.name}</h3>
                                <div class="flex gap-2 text-[10px] font-mono uppercase text-slate-500">
                                    <span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded">วีค: ${weekGold.toLocaleString()} g</span>
                                    <span class="bg-slate-100 px-1.5 py-0.5 rounded">รวม: ${totalGold.toLocaleString()} g</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="handleDonate('${m.id}')" data-id="${m.id}" ${hasDonated ? 'disabled' : ''} 
                                class="flex items-center gap-1.5 px-4 py-2 rounded-xl border transition-all text-xs font-bold ${hasDonated ? 'bg-green-100 text-green-700 border-green-200 cursor-default' : 'bg-slate-100 text-slate-500 border-slate-200 hover:bg-slate-200 active:scale-95'}">
                            <i data-lucide="${hasDonated ? 'check-circle-2' : 'plus'}" class="w-3.5 h-3.5"></i>
                            ${hasDonated ? 'บริจาคแล้ว' : 'บริจาค'}
                        </button>
                    </div>
                    <div class="flex items-center justify-end border-t md:border-t-0 pt-3 md:pt-0 border-slate-50">
                        <button onclick="confirmDeleteModal('${m.id}', '${m.name}')" class="p-2 text-slate-200 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                listEl.appendChild(card);
            });

            if (filtered.length === 0) listEl.innerHTML = `<div class='py-20 text-center text-slate-300 italic text-sm'>ยังไม่มีรายชื่อสมาชิก...</div>`;

            // Render History
            const hList = document.getElementById('historyList');
            hList.innerHTML = '';
            [...donations].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(d => {
                const member = members.find(m => m.id === d.memberId);
                const row = document.createElement('div');
                row.className = `p-4 flex justify-between items-center border-b border-slate-50 last:border-0`;
                row.innerHTML = `<div><div class="font-bold text-slate-800 text-sm">${member ? member.name : 'Unknown Member'}</div>
                                 <div class="text-[9px] text-slate-400 tracking-tight">${new Date(d.timestamp).toLocaleString('th-TH')}</div></div>
                                 <div class="font-mono font-bold px-3 py-1 rounded-full text-xs bg-green-50 text-green-700">+${Number(d.amount).toLocaleString()} g</div>`;
                hList.appendChild(row);
            });
            document.getElementById('historyCount').innerText = `${donations.length}`;
            lucide.createIcons();
        };

        // --- Helpers ---
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if(show) { el.classList.add('modal-active'); if(id==='modal-add') document.getElementById('newMemberName').focus(); }
            else el.classList.remove('modal-active');
        };

        window.validateName = () => {
            const name = document.getElementById('newMemberName').value.trim();
            const isTaken = members.some(m => m.name.toLowerCase() === name.toLowerCase());
            document.getElementById('dupError').classList.toggle('hidden', !isTaken);
            document.getElementById('btnConfirmAdd').disabled = isTaken || !name;
        };

        window.confirmDeleteModal = (id, name) => {
            document.getElementById('deleteDesc').innerHTML = `ลบ <span class='font-bold'>${name}</span> ?`;
            document.getElementById('btnConfirmDelete').onclick = () => handleDeleteMember(id);
            toggleModal('modal-delete', true);
        };

        window.switchView = (view) => {
            document.getElementById('view-members').classList.toggle('hidden', view !== 'members');
            document.getElementById('view-history').classList.toggle('hidden', view !== 'history');
            document.getElementById('tab-members').className = view === 'members' ? "flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-indigo-600 text-white shadow-lg" : "flex-1 py-2 rounded-lg text-sm font-medium transition-all text-slate-400";
            document.getElementById('tab-history').className = view === 'history' ? "flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-indigo-600 text-white shadow-lg" : "flex-1 py-2 rounded-lg text-sm font-medium transition-all text-slate-400";
        };
    </script>
</body>
</html>
